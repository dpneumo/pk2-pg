yum -y update

config_server.sh


sudo yum -y install postgresql-server postgresql-contrib
sudo postgresql-setup initdb
sudo nano /var/lib/pgsql/data/pg_hba.conf
  Change:
    host    all             all             127.0.0.1/32            ident
    host    all             all             ::1/128                 ident
  To:
    host    all             all             127.0.0.1/32            md5
    host    all             all             10.136.76.238/32        md5
    host    all             all             ::1/128                 md5
sudo systemctl start postgresql
sudo systemctl enable postgresql

sudo -i -u postgres
createuser --interactive
  name:       minerva
  superuser?: no
  createdb?:  yes
  newroles?:  no

############################################
# iptables setup scriptfor dbservs:

#!/bin/bash
# iptables rules script

# Constants
 WAN_IF="eth0"
 MAN_IP="0.0.0.0/0"

 PVT_IF="eth1"
 LAN_IP="10.136.0.0/16"

# Flush all current rules from iptables (ignores mangle, raw and security tables)
 iptables -F
 iptables -X
 iptables -t nat -F
 iptables -t nat -X

# Create user defined tables ###############
 iptables -N psql_in
 iptables -N psql_out
 iptables -N ssh_in
 iptables -N ssh_out
 iptables -N dns_in
 iptables -N dns_out
 iptables -N dhcp_in
 iptables -N dhcp_out
 iptables -N ntp_in
 iptables -N ntp_out
 iptables -N icmp_in
 iptables -N icmp_out
 iptables -N logging

# Default policies #########################
 iptables -P INPUT DROP
 iptables -P FORWARD DROP
 iptables -P OUTPUT DROP


# INPUT chain ##############################
 iptables -A INPUT -i lo -j ACCEPT

 #Act as Server
 iptables -A INPUT -p tcp --dport 22 -j ssh_in
 iptables -A INPUT -p tcp --dport 5432 -j psql_in

 #Act as Client
 iptables -A INPUT -p tcp --sport 53 -j dns_in
 iptables -A INPUT -p udp --sport 53 -j dns_in
 iptables -A INPUT -p udp --sport 67:68 -j dhcp_in
 iptables -A INPUT -p udp --sport 123 -j ntp_in

 #ICMP
 iptables -A INPUT -p icmp -j icmp_in

 #Logging
 iptables -A INPUT -j logging


# OUTPUT chain #############################
 iptables -A OUTPUT -o lo -j ACCEPT

 #Act as Server
 iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT

 #Act as Client
 iptables -A OUTPUT -p tcp --dport 53 -j dns_out
 iptables -A OUTPUT -p udp --dport 53 -j dns_out
 iptables -A OUTPUT -p udp --dport 67:68 -j dhcp_out
 iptables -A OUTPUT -p udp --dport 123 -j ntp_out

 #ICMP
 iptables -A OUTPUT -p icmp -j icmp_out

 #Logging
 iptables -A OUTPUT -j logging


# FORWARD chain ############################
 iptables -A FORWARD -j logging


# Service chains ###########################
# psql_* chains (server)
 # Only accept psql packets on the internal ip address
 iptables -A psql_in  -i "$LAN_IF" -p tcp --dport 5432 -m state --state NEW,ESTABLISHED -j ACCEPT

# ssh_* chains (server)
 # Only accept SSH from an external Management ip address
 # Replace the following with management specific rules.
 iptables -A ssh_in  -i "$WAN_IF" -s "$MAN_IP" -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT

# dns_* chains (client)
 iptables -A dns_out -o "$WAN_IF" -p udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
 iptables -A dns_out -o "$WAN_IF" -p tcp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
 iptables -A dns_in  -i "$WAN_IF" -p udp --sport 53 -m state --state ESTABLISHED -j ACCEPT
 iptables -A dns_in  -i "$WAN_IF" -p tcp --sport 53 -m state --state ESTABLISHED -j ACCEPT

# dhcp_* chains (client)
 iptables -A dhcp_out -o "$WAN_IF" -p udp -m udp --dport 67:68 -m state --state NEW,ESTABLISHED -j ACCEPT
 iptables -A dhcp_in  -i "$WAN_IF" -p udp -m udp --sport 67:68 -m state --state ESTABLISHED -j ACCEPT

# ntp_* chains (client)
 iptables -A ntp_out -o "$WAN_IF" -p udp --dport 123 -m state --state NEW,ESTABLISHED -j ACCEPT
 iptables -A ntp_in  -i "$WAN_IF" -p udp --sport 123 -m state --state ESTABLISHED -j ACCEPT

# icmp_* chains
 iptables -A icmp_in  -p icmp -m icmp --icmp-type 0 -j ACCEPT
 iptables -A icmp_in  -p icmp -m icmp --icmp-type 3 -j ACCEPT
 iptables -A icmp_in  -p icmp -m icmp --icmp-type 8 -j ACCEPT
 iptables -A icmp_in  -p icmp -m icmp --icmp-type 11 -j ACCEPT
 iptables -A icmp_in  -p icmp -m icmp --icmp-type 12 -j ACCEPT
 iptables -A icmp_out -p icmp -m icmp --icmp-type 8 -j ACCEPT

# logging chain
 #Skip these
 iptables -A icmp_in -j DROP
 iptables -A INPUT -m state --state INVALID -j DROP
 #Log all else
 iptables -A logging -m limit --limit 2/min --limit-burst 10 \
          -j LOG --log-prefix "IPTables-Dropped: " --log-level 4


# Save settings ############################
 /sbin/service iptables save

# List rules ###############################
 printf "\n\nFILTER table\n"
 iptables -L -v --line-numbers
 printf "\n\nNAT table\n"
 iptables -t nat -L -v --line-numbers
EOF
